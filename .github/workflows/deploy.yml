name: ğŸš€ Vercel Deployment Workflow

on:
  push:
    branches:
      - main # Trigger on pushes to the 'main' branch
  workflow_dispatch: # Allows manual triggering of the workflow

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout source code
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v3

      # Step 2: Set up Node.js
      - name: ğŸ› ï¸ Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18" # Use Node.js version 18

      # Step 3: Install dependencies
      - name: ğŸ”¨ Install Dependencies
        run: |
          echo -e "\033[33mğŸ”¨ Installing dependencies...\033[0m"
          npm install
          echo -e "\033[32mâœ”ï¸ Dependencies installed successfully!\033[0m"

      # Step 4: Generate vercel.json
      - name: ğŸ“ Generate vercel.json
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo -e "\033[36mğŸ“ Generating vercel.json...\033[0m"
          npm run create-vercel.json-file $SITE_URL
          echo -e "\033[32mâœ”ï¸ vercel.json generated successfully!\033[0m"

      # Step 5: Download the Curriculum Vitae
      - name: ğŸ“¥ Download Curriculum Vitae
        env:
          API_SECRET_KEY: ${{ secrets.API_SECRET_KEY }}
          SITE_URL: ${{ secrets.SITE_URL }}
        run: |
          echo -e "\033[33mğŸ“¥ Downloading Curriculum Vitae...\033[0m"
          npm run cv:download $API_SECRET_KEY $SITE_URL
          echo -e "\033[32mâœ”ï¸ Curriculum vitae downloaded successfully!\033[0m"

      # (Optional) Step 6: Build the Astro project
      # - name: ğŸš€ Build Astro Project
      #   run: |
      #     echo -e "\033[33mğŸš€ Building the Astro project...\033[0m"
      #     npm run build
      #     echo -e "\033[32mâœ”ï¸ Build complete!\033[0m"

      # Step 7: Deploy to Vercel
      - name: ğŸŒ Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo -e "\033[34mğŸŒ Deploying to Vercel...\033[0m"
          npx vercel --prod --token=$VERCEL_TOKEN --scope=$VERCEL_ORG_ID --yes
          echo -e "\033[32mâœ”ï¸ Deployment successful!\033[0m"

      # Step 8: Clean up sensitive files
      - name: ğŸ§¹ Clean Up Sensitive Files
        run: |
          echo -e "\033[31mğŸ§¹ Cleaning up sensitive files...\033[0m"
          rm -f vercel.json
          npm cache clean --force
          echo -e "\033[32mâœ”ï¸ Clean-up complete!\033[0m"
